<!DOCTYPE html>
<html>
<head>
    <title>Encuesta de Satisfacción</title>
</head>
<body>
    <h1>Encuesta de Satisfacción: {{ encuesta.titulo }}</h1>
    <form id="encuestaForm">
        <label for="nombre">Nombre:</label>
        <input type="text" name="nombre" id="nombre">
        <input type="hidden" name="encuesta_id" value="{{ loop.index0 }}">
        {% for pregunta in encuesta.preguntas %}
            <label for="pregunta_{{ loop.index0 }}">{{ pregunta }}</label>
            <input type="text" name="pregunta_{{ loop.index0 }}" id="pregunta_{{ loop.index0 }}">
        {% endfor %}
        <button type="submit">Enviar</button>
    </form>
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
    <py-script>
        from js import document, fetch

        async def enviarEncuesta(event):
            event.preventDefault()
            nombre = document.getElementById('nombre').value
            encuesta_id = int(document.getElementById('encuesta_id').value)
            respuestas = {f'pregunta_{i}': document.getElementById(f'pregunta_{i}').value for i in range(len(document.querySelectorAll('[id^="pregunta_"]')))}
            await fetch('/usuario', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({'nombre': nombre, 'encuesta_id': encuesta_id, 'respuestas': respuestas})
            })
            if confirm('¿Desea rellenar otra encuesta?'):
                window.location.reload()
            else:
                window.location.href = '/'

        document.getElementById('encuestaForm').addEventListener('submit', enviarEncuesta)
    </py-script>
</body>
</html>
